# 十、进程、线程、集群

## 1. process 模块

### (1) process API

```js
定义：import process from 'process'
属性：操作系统属性：
     process.arch                                      //返回当前Node进程所在操作系统的CPU架构
     process.platform                                  //返回当前Node进程所在操作系统平台
     用户环境属性：
     process.env                                       //返回当前Node进程所在的用户环境对象
     Node 属性：
     process.release                                   //返回当前Node进程使用的Node版本对象
     process.version                                   //返回当前Node进程使用的Node版本
     process.versions                                  //返回当前Node进程使用的Node及其依赖项版本对象
     process.execPath                                  //当前当前Node进程的可执行文件的绝对路径
     process.config                                    //返回当前Node进程的可执行文件的只读配置对象
     进程属性：
     process.pid                                       //返回当前Node进程唯一标识
     process.ppid                                      //返回当前Node进程的父进程的pid
     process.title                                     //返回当前Node进程标题
     process.argv                                      //返回当前Node进程启动时传入的命令行参数(第一个参数是process.execPath,第二个参数是正在执行的JS文件路径)
     process.execArgv                                  //返回当前Node进行启动时传入的一组特定于Node命令行选项,不会出现在process.argv,可用于衍生与父进程具有相同执行环境的子进程
     process.debugPort                                 //返回当前Node进程的调试端口
     process.exitCode                                  //返回/设置当前Node进程的退出码
     process.report                                    //返回当前Node进程的诊断报告对象{compact,directory,filename,}
     process.noDeprecation                             //返回当前Node进程是否设置了--no-deprecation标志
     process.throwDeprecation                          //返回当前Node进程是否设置了--throw-deprecation标志
     process.traceDeprecation                          //返回当前Node进程是否设置了--trace-deprecation标志
     IPC 通道属性：
     process.channel                                   //返回当前Node进程对IPC通道的引用,无则返回undefined
     process.connected                                 //返回当前Node进程使用的IPC通过是否仍连接
     输入输出属性：
     process.stdin                                     //返回当前Node进程的标准输入流
     process.stdin.fd                                  //返回当前Node进程的标准输入流的底层文件名描述符
     process.stdout                                    //返回当前Node进程的标准输出流
     process.stdout.fd                                 //返回当前Node进程的标准输出流的底层文件名描述符
     process.stderr                                    //返回当前Node进程的错误输出流
     process.stderr.fd                                 //返回当前Node进程的错误输出流的底层文件名描述符
方法：身份标识方法：
     process.getuid()                                  //返回当前Node进程的数字用户标识
     process.setuid(id)                                //无返回值,设置当前Node进程的数字用户标识
     process.geteuid()                                 //返回当前Node进程的数字有效用户身份
     process.seteuid(id)                               //无返回值,设置当前Node进程的数字有效用户身份
     process.getgid()                                  //返回当前Node进程的数字群组标识
     process.setgid(id)                                //无返回值,设置当前Node进程的数字群组标识
     process.getegid()                                 //返回当前Node进程的数字有效群组标识
     process.setegid(id)                               //无返回值,设置当前Node进程的数字有效群组标识
     process.getgroups()                               //返回当前Node进程的带有补充组ID的数组
     process.setgroups(groups)                         //无返回值,设置当前Node进程的带有补充组ID的数组
     process.initgroups(user,extraGroup)               //无返回值,读取/etc/group文件并使用用户所属的所有组初始化组访问列表 
     Node 进程方法：
     process.hrtime.bigint()                           //返回当前Node进程已经运行的纳秒数
     process.uptime()                                  //返回当前Node进程已经运行的秒数
     process.cpuUsage([preVal])                        //返回当前Node进程的用户和系统CPU时间使用情况(微秒)
     process.memoryUsage()                             //返回当前Node进程的内存使用量对象(字节)
     process.resourceUsage()                           //返回当前Node进程的资源使用情况
     process.cwd()                                     //返回当前Node进程的当前工作目录
     process.chdir(directory)                          //无返回值,更改当前Node进程的当前工作目录
     process.dlopen(module,filename,[flags])           //无返回值,动态加载共享对象
     process.nextTick(cb,[...args])                    //无返回值,将回调cb添加到下一个事件循环
     process.emitWarning(warning,[options])            //无返回值,触发自定义或特定于应用程序的进程警告
     process.emitWarning(warning,[type,[code]],[ctor]) //无返回值,触发自定义或特定于应用程序的进程警告
     process.kill(pid,[signal])                        //无返回值,将可选参数signal信号发送到pid标识的进程
     process.abort()                                   //无返回值,中止当前Node进程并生成一个核心文件
     process.exit([code])                              //无返回值,指定当前Node进程以退出码code同步终止进程,即使仍有未完成的异步操作,大多数情况下没必要调用该方法,事件循环中没有待处理工作则Node进程会自行退出
     process.setUncaughtExceptionCaptureCallback(fn)   //无返回值,设置当前Node进程发生未捕获异常时的回调函数
     process.hasUncaughtExceptionCaptureCallback()     //返回当前Node进程是否已使用process.setUncaughtExceptionCaptureCallback()设置回调
     IPC 通道方法：
     process.send(message,[sendHandle,[options]],[cb]) //无返回值,当前Node进程向父进程发送消息
     process.disconnect()                              //无返回值,关闭当前Node进程通往父进程的 IPC 通道    
```

### (2) process 事件

```js
process 事件：
message                  //当前 Node 进程接收到子进程发送的消息时触发
beforeExit               //当前 Node 进程清空其事件循环且没有额外的工作要安排时触发
disconnect               //当前 Node 进程使用的 IPC 通道关闭时触发
exit                     //当前 Node 进程即将关闭时触发(code)
warning                  //当前 Node 进程触发警告时触发(name,message,stack)

worker 事件：
worker                   //当前 Node 进程创建新的 worker 线程时触发(worker)

未捕获的错误事件：
uncaughtException        //当未捕获的 JS 异常一直冒泡回到事件循环时触发(err,origin)
uncaughtExceptionMonitor //当 uncaughtException 要触发时在其之前触发(err,origin)
multipleResolves         //当 Promise 解决了多次、解决后拒绝、拒绝了多次、拒绝后解决时触发,用于跟踪应用程序使用Promise的潜在错误(type,promise,value)
rejectionHandled         //当 Promise 被拒绝且错误句柄被附加到晚一轮的事件循环时触发(promise)
unhandledRejection       //当 Promise 被拒绝且在事件循环的一个轮询内没有错误句柄附加到承诺时触发(reason,Promise)

信号事件
```

### (3) 进程退出码

* **0（默认）**：成功退出
* **1**：未捕获的致命异常
* **2**：未使用
* **3**：内部 JS 解析错误
* **4**：内部 JS 评估失败
* **5**：致命错误
* **6**：非函数的内部异常句柄
* **7**：内部异常句柄运行时失败
* **8**：未使用
* **9**：无效参数
* **10**：内部 JS 运行时失败
* **12**：无效的调试参数
* **13**：未完成的顶层等待
* **>128**：信号退出

## 2. child_process 模块

### (1) child_process API

默认情况下，会在父进程和其衍生子进程之间建立 `stdin、stdout、stderr 管道`，这些管道的`容量有限且特定于平台`，如果子进程在没有捕获输出的情况下写入标准输出超过限制，则子进程会阻塞等待管道缓冲区能够接收更多数据

```js
定义：import child_process from 'child_process'
属性：child_process
方法：衍生异步子进程：
     child_process.spawn(command,[args],[options])                               //返回ChildProcess实例,当前Node进程衍生Shell作为新的子进程,并在其中执行命令command
     child_process.exec(command,[options],[(err,stdout,stderr)=>{}])             //返回ChildProcess实例,当前Node进程衍生Shell作为新的子进程,并在其中执行命令command,缓冲生成的输出
     child_process.execFile(nodeFile,[args],[options],[(err,stdout,stderr)=>{}]) //返回ChildProcess实例,当前Node进程直接将可执行文件nodeFile作为新的子进程衍生
     child_process.fork(jsModulePath,[args],[options])                           //返回ChildProcess实例,当前Node进程使用modulePath
     衍生同步子进程：
     child_process.spawnSync(command,[args],[options])                           //返回子进程对象,同child_process.spawn()
     child_process.execSync(command,[options])                                   //返回命令的标准输出,同child_process.exec()
     child_process.execFileSync(file,[args],[options])                           //返回命令的标准输出,同child_process.execFile()
```

### (2) ChildProcess 类

```js
定义：import child_process from 'child_process'
     const subprocess = child_process.spawn()
     const subprocess = child_process.exec()
     const subprocess = child_process.execFile()
     const subprocess = child_process.fork()
     const subprocess = child_process.spawnSync()
     const subprocess = child_process.execSync()
     const subprocess = child_process.execFileSync()
属性：子进程属性：
     subprocess.pid                                   //返回当前子进程的唯一标识
     subprocess.spawnfile                             //返回当前子进程的可执行文件名
     subprocess.spawnargs                             //返回当前子进程启动时使用的命令行参数的完整列表
     subprocess.killed                                //返回当前子进程是否成功接收到来自subprocess.kill()的信号
     subprocess.signalCode                            //返回当前子进程接收到的信号
     subprocess.connected                             //返回当前子进程是否仍处于连接状态,可接收和发送消息
     subprocess.exitCode                              //返回当前子进程的退出码
     输入输出属性：
     subprocess.stdio                                 //返回当前子进程的
     subprocess.stdin                                 //返回当前子进程的标准输入流
     subprocess.stdout                                //返回当前子进程的标准输出流
     subprocess.stderr                                //返回当前子进程的错误输出流
     IPC 通道属性：
     subprocess.channel                               //返回当前子进程的 IPC 通道管道
方法：基本方法：
     subprocess.unref()                               //无返回值,父进程的事件循环不将当前子进程包含在其引用计数中,从而允许父进程独立于子进程退出
     subprocess.ref()                                 //无返回值,父进程的事件循环恢复当前子进程在其引用计数中,迫使父进程等待子进程退出
     父子进程通信方法：
     subprocess.kill([signal])                        //返回是否成功将可选参数signal信号发送给当前子进程
     subprocess.send(msg,[sendHandle,[options]],[cb]) //返回是否成功将消息msg发送给当前子进程,当前子进程可通过message事件接收消息
     subprocess.disconnect()                          //无返回值,关闭当前子进程和父进程的 IPC 通道,父子进程间将无法再传递消息


事件：
spawn      //当前子进程衍生成功时触发
message    //当前子进程接收到父进程的消息时触发
exit       //当前子进程退出时触发,输入输出流可能仍打开
close      //当前子进程结束且标准输入输出流已关闭时触发
disconnect //当前子进程关闭连接时触发
error      //当前子进程发生错误时触发
```

### (3) 实例

衍生同步子进程会`阻塞父进程的事件循环`，暂停任何其他代码的执行，直到衍生的子进程退出或终止，这样的阻塞对于简化通用脚本任务和在启动时简化应用程序配置的加载和处理非常有用，但是也会对性能产生重大影响

衍生异步子进程不会阻塞父进程的事件循环

* index.js

     ```js
     import child_process from 'child_process'

     const subProcess = child_process.fork('child.js')
     subProcess.send({ name: 'parent' })
     subProcess.on('message', childMsg => {
          console.log("childMsg:", childMsg)
     })

     console.log('hello, I am parent')
     ```

* child.js

     ```js
     import process from 'process'

     process.send({ name: 'child' })
     process.on('message', parentMsg => {
          console.log('parentMsg:', parentMsg)
     })
     ```

* node parent.js
  ![异步子进程通信]()

## 3. cluster 模块

### 集群

为了利用多核 CPU 系统，用户有时想要启动 Node 进程的集群来处理负载，集群可以轻松创建共享服务器端口的子进程，子进程使用 child_process.fork() 方法衍生，因此可以通过 IPC 通道与父进程通信并且来回传递服务器句柄

集群模块支持 2 种分发传入连接的方法

* 主进程监听端口，接收新连接并以循环方式将其分发给子进程，其中使用一些内置智能以避免使子进程过载（除 Windows 之外的所有平台的默认方法）
* 主进程创建监听套接字并将其发送给感兴趣的子进程，然后子进程直接接收传入的连接，理论上该方法具有最好的性能，但实践中由于操作系统调度机制难以琢磨，分发往往非常不平衡，可能出现 8 个子进程中的 2 个子进程分担了所有连接超过 70% 的负载

由于 server.listen() 将大部分工作交给了主进程，因此主进程和集群子进程之间的行为在以下 3 种情况下有所不同

* **server.listen({fd: 7})**：
* **server.listen(handle)**：
* **server.listen(0)**：

由于子进程都是独立进程，可以根据程序的需要被杀死或重新衍生而不会影响其他子进程，只要还有子进程仍然活动，服务器就会继续接收连接，如果没有子进程活动，现有连接将被丢弃，新连接将被拒绝，但是 Node 不会自动管理子进程的数量，行用程序有责任根据自己的需要管理子进程池

### cluster API

```js
定义：import cluster from 'cluster'
属性：
     cluster.isMaster                 //
     cluster.isPrimary                //
     cluster.isWorker                 //
     cluster.schedulingPolicy         //
     cluster.settings                 //
     cluster.worker                   //
     cluster.workers                  //
方法：
     cluster.disconnect([cb])         //
     cluster.fork([env])              //
     cluster.setupMaster([settings])  //
     cluster.setupPrimary([settings]) //


事件：
disconnect //
exit       //
fork       //
listening  //
message    //
online     //
setup      //
```

### (2) Worker 类

```js
定义：import worker_threads from 'worker_threads'
属性：
     worker.exitedAfterDisconnect                 //
     worker.id                                    //
     worker.process                               //
方法：
     worker.disconnect()                          //
     worker.isConnected()                         //
     worker.isDead()                              //
     worker.kill([signal])                        //
     worker.send(msg,[sendHandle,[options]],[cb]) //


事件：
disconnect //
error      //
exit       //
listening  //
message    //
online     //
```

```js

```

## 4. worker_threads 模块

### (1) worker_threads API

工作线程对于处理 CPU 密集型操作很有用，对于 IO 密集型操作帮助不大，Node 内置的异步 IO 操作比工作线程更高效

```js
定义：import worker_threads from 'worker_threads'
属性：
方法：
```

①②③④⑤⑥⑦⑧⑨⑩
