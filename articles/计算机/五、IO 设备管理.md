# 五、IO 设备管理

[[_TOC_]]

## 1. IO 系统的层次结构

层次式的 IO 系统，每一层都是利用下层提供的服务，完成输入输出功能的某些子功能，并屏蔽这些功能实现的细节，向高层提供服务

**① 用户层 IO 软件**：提供`系统调用`，系统调用是为了应用程序在执行过程中访问系统资源而设置的，是`应用程序获得操作系统服务`的唯一途径

**② 设备独立性软件**：实现设备命名、设备保护、设备的分配与释放、同时为设备管理和数据传送提供必要的存储空间

**③ 设备驱动程序**：设备驱动程序主要用于实现 `CPU 和设备控制器之间的通信`

**④ 中断处理程序**：首先保护`阻塞进程`的 CPU 环境，然后 CPU 自动转而执行中断处理程序，执行完后再回到断点处，唤醒并继续执行原来的进程

**⑤ 设备控制器**：设备控制器是 `CPU 和 IO 设备之间的接口`，接收 CPU 发来的命令控制设备工作，使 CPU 从繁杂的设备控制事务中解脱出来

**⑥ 设备**：磁盘、输入设备 ( 鼠标、键盘、扫描仪、视频摄像头 )、输出设备 ( 显示器、打印机、绘图仪 )

![IO系统的层次](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/IO%E7%AE%A1%E7%90%86/IO%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%B1%82%E6%AC%A1.png)

![层次视图](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/IO%E7%AE%A1%E7%90%86/%E5%B1%82%E6%AC%A1%E8%A7%86%E5%9B%BE.png)

## 2. 设备控制器

### (1) 设备控制器的概念

设备控制器是 `CPU 和 IO 设备之间的接口`，接收 CPU 发来的命令控制设备工作，使 CPU 从繁杂的设备控制事务中解脱出来

设备控制器可以控制多少设备，就有多少个设备地址，每个设备对应一个设备地址

### (2) 设备控制器的功能

**① 接收和识别命令**：设备控制器接收和识别 CPU 发来的各种命令到`控制寄存器`，并对其进行译码

**② 数据交换**：设备控制器实现 CPU 和设备之间的数据交换，为此需要将数据暂存到`数据寄存器`

**③ 标示和报告设备的状态**：设备控制器记录控制的每个设备的状态到`状态寄存器`，供 CPU 了解

**④ 地址识别**：设备控制器记录控制的每个设备的地址到`地址译码器`

![设备控制器](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/IO%E7%AE%A1%E7%90%86/%E8%AE%BE%E5%A4%87%E6%8E%A7%E5%88%B6%E5%99%A8.png)

## 3. 中断处理程序

### (1) 中断

**① 外中断**：来自 CPU 外部的`设备`引起的中断信号，例如各种 IO 设备引起的中断

**② 内中断**：来自 CPU 内部的`进程`引起的中断信号，例如运算溢出、非法指令、地址越界、电源故障等

### (2) 中断处理流程

首先保护`阻塞进程`的 CPU 环境，然后 CPU 自动转而执行中断处理程序，执行完后再回到断点处，唤醒并继续执行原来的进程

![中断处理流程](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/IO%E7%AE%A1%E7%90%86/%E4%B8%AD%E6%96%AD%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B.png)

## 4. 设备驱动程序

### (1) 设备驱动程序的作用

设备驱动程序主要用于实现 `CPU 和设备控制器之间的通信`

### (2) 设备驱动程序的处理过程

**① 校验 CPU 命令**：设备驱动程序在收到 CPU 发来的命令时，需要先检查这些命令，确认设备能否执行，避免非法请求，例如 CPU 要求从打印机读取数据

**② 抽象要求转换为具体要求**：设备控制器中有若干寄存器用于暂存命令、参数、数据，但由于上层软件对于设备控制器的具体情况并不了解，只能发出抽象的命令，而设备控制器无法理解这些抽象命令，因此需要设备驱动程序将抽象命令转换为设备控制器能够理解的具体要求，例如将抽象命令中的盘块号转换为磁盘的盘面、磁道号、扇区

**③ 检查设备状态**：启动某个设备的前提是该设备处于就绪状态，因此设备驱动程序需要先读取`设备控制器的状态寄存器`中的内容，来确定设备是否处于就绪状态，只有处于就绪状态，才能启动设备所属的设备控制器

**④ 传送必要的参数**：在确认设备处于就绪状态后，设备驱动程序就可以向设备所属的`设备控制器的数据寄存器传送数据`

**⑤ 启动设备**：在完成所有上述准备工作后，设备驱动程序就可以向设备所属的`设备控制器的控制寄存器传送命令`

## 5. 设备独立性软件

### (1) 设备独立性

#### ① 物理设备名

早期操作系统中，进程使用物理设备名来请求 IO 操作

例如进程 A 运行时通过物理设备名请求某一台打印机，这台打印机被 CPU 分配给其他进程，那么即使还有不同物理设备名的其他打印机空闲，CPU 也不能分配给进程 A，进程 A 就会因为请求 IO 操作失败而自动进入阻塞状态

#### ② 逻辑设备名

逻辑设备名是`设备的功能类型`，并没有指明是具体哪一台设备，为了实现设备独立性而引入了逻辑设备名这个概念

例如进程 A 运行时通过逻辑设备名请求打印机，CPU 就会查找打印机的第一台，如果已分配就立即查找第二台，只要有一台打印机空闲，进程 A 就不会阻塞

#### ③ 逻辑设备名到物理设备名的转换

操作系统配置一张`逻辑设备表`来实现逻辑设备名和物理设备名的转换

### (2) 设备独立性软件的功能

#### ① 设备驱动程序统一接口

要求每个设备驱动程序与操作系统之间都有着相同或相近的接口，这样会使添加新的设备驱动程序很容易，也便于开发人员对设备驱动程序的编写

#### ② 差错控制

设备有着许多机械和电气部分，比主机更容易出现故障，导致 IO 操作的大多数错误都与设备有关，因此需要设备独立性软件进行差错控制

* **暂时性错误**：暂时性事件引起的错误，例如电源波动、磁盘传送错误等等
* **持久性错误**：持久性故障引起的错误，例如电源掉电、磁盘损坏等等

#### ③ 独占设备的分配与回收

独占设备属于临界资源，由操作系统统一分配，不允许进程自行使用，进程要使用必须先向操作系统提出申请

#### ④ 独立于设备的逻辑数据块

不同类型的设备、其数据交换单位、读取和传输速率各不相同，即使是同一类型的设备，其数据交换单位也是有差异的

设备独立性软件能够隐藏这些差异，向高层软件提供统一的逻辑数据块

![设备独立性软件的功能层次](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/IO%E7%AE%A1%E7%90%86/%E8%AE%BE%E5%A4%87%E7%8B%AC%E7%AB%8B%E6%80%A7%E8%BD%AF%E4%BB%B6%E7%9A%84%E5%8A%9F%E8%83%BD%E5%B1%82%E6%AC%A1.png)

## 6. 用户层 IO 软件

### (1) 用户与计算机硬件系统之间的接口

用户在操作系统的帮助下能够快速便捷地运行自己的程序或者操纵计算机硬件，用户能够通过三种方式实现与操作系统的通信

#### ① 系统调用 ( 应用程序 )

系统调用是为了应用程序在执行过程中访问系统资源而设置的，是`应用程序获得操作系统服务`的唯一途径

每一个系统调用都是一个能完成特定功能的子程序，每当应用程序要求操作系统提供某种服务时，就调用具有相应功能的系统调用

在高级程序语言中，往往提供了与各个系统调用一一对应的`库函数`

#### ② 命令 ( 用户 )

用户通过向应用程序发出`命令`以控制应用程序的运行

用户在终端或控制台键入一条命令后，命令解释程序立即对该命令加以解释执行，完成指定功能后又返回到终端或控制台，等待用户键入下一条命令，这样用户便可以通过先后键入不同命令的方式控制应用程序的执行

#### ③ 图形化用户接口 GUI ( 用户 )

由于命令不便于用户记忆和使用，因此诞生了图形化用户接口 GUI

GUI 采用了图形化的操作界面，将窗口、图标、菜单、鼠标和面向对象技术集成到一起，引入形象的各种图标，将操作系统的各项功能、各种应用程序、各种文件直观逼真的表示出来，形成一个图文并茂的视窗操作环境

有了 GUI，可以直接在系统桌面上显示各种常用图标，每个图标对应一个应用程序，用户只需双击图标就可以启动应用程序 ( 无需键入命令 )，用户还可以通过选择窗口、菜单、对话框、滚动条，完成对应用程序的各种控制和操作

![用户与计算机硬件之间的接口](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%94%A8%E6%88%B7%E4%B8%8E%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A1%AC%E4%BB%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E6%8E%A5%E5%8F%A3.png)

### (2) 系统调用

大部分 IO 软件都放在操作系统内部，但仍有小部分 IO 软件在用户层，比如系统调用

系统调用是为了应用程序在执行过程中访问系统资源而设置的，是`应用程序获得操作系统服务`的唯一途径

### (3) 库函数

在高级程序语言中，往往提供了与各个系统调用一一对应的库函数
