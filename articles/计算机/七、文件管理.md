# 七、文件管理

[[_TOC_]]

## 1. 文件

### (1) 文件的组成

文件系统的管理功能就是将管理的`程序和数据`组织为一系列文件

* **数据项**：数据项是一个对象的某种属性的字符集，数据项又称字段，是数据组织中可以命名的最小逻辑单位，例如姓名、年龄
* **记录**：记录是一个对象在某方面的属性，关键字能够唯一标识某个记录

  ```js
  //数据项：name=张三、age=20
  //记录：{ name: '张三', age: 20 }, name 为关键字

  {
    name: '张三',
    age: 20,
  },
  {
    name: '李四',
    age: 20,
  },
  {
    name: '王五',
    age: 20,
  }
  ```

![文件的组成](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%84%E6%88%90.png)

### (2) 文件的属性

* **文件类型**：通过文件`扩展名/后缀名`来标识文件类型，例如 file.txt 中 txt 表示文本文件
* **文件长度**：文件的长度，可以是字节
* **文件的物理位置**：文件在磁盘上的物理位置
* **文件的建立时间**：文件的`最后修改时间`

### (3) 文件的分类

#### ① 按用途分类

* 系统文件：系统程序构成的文件
* 用户文件：应用程序构成的文件
* 库文件：系统调用文件

#### ② 按数据形式分类

* 源文件：源程序和数据构成的文件
* 目标文件：源文件编译后的目标文件
* 可执行文件：目标文件链接后的可执行文件

#### ③ 按存取控制属性分类

* 只执行文件：不允许读写
* 只读文件
* 读写文件

## 2. 文件管理系统

### (1) 文件管理系统的管理对象

#### ① 文件

各种不同类型的文件

#### ② 目录

设置目录是为了方便对文件的存取和检索，目录的每个目录项中必须包含文件名、文件属性等

#### ③ 磁盘空间

文件和目录必定占据存储空间，对这部分磁盘空间的有效管理，不仅能提高磁盘的利用率，还能提高文件的存取速率

### (2) 文件管理系统的功能

#### ① 文件保护

* 防止未经核准的用户存取文件
* 防止冒名顶替的用户存取文件
* 防止以不正确的方式使用文件

#### ② 文件读写管理

操作系统根据用户给出的文件名检索文件目录，获得文件在磁盘上的位置，然后利用文件读写指针对文件进行读写

#### ③ 文件目录管理

操作系统为每个文件建立一个目录项，包括文件名、文件属性等，对众多目录项加以有效地组织，以实现方便地按名存取

#### ④ 文件磁盘空间管理

操作系统为每个文件分配必要的磁盘空间，提高磁盘的利用率，进而提高文件系统的读写速度，为此需要设计相应的数据结构用于记录文件磁盘空间的使用情况，以供分配和回收时参考

## 3. Linux 文件系统

### (1) Linux 虚拟文件系统（Virtual File System）

Linux 允许众多不同的实际文件系统共存（ext2, ext3, btrfs, ...），通过使用`同一套文件调用`即可对 Linux 中任意文件进行操作而无需考虑其所在的实际文件系统格式，更进一步对文件的操作还可以跨文件系统执行

![跨文件系统的文件操作](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E8%B7%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C.jpg)

Linux 有一个重要概念：`一切皆是文件，包括硬件设备`。普通文件、目录、字符设备、块设备、套接字等等在 Linux 中都是以文件被对待，虽然类型不同，但提供的都是同一套操作界面，特别是 Linux 将硬件看作设备文件，这样用户就可以通过读写文件的方式访问硬件

![一切皆是文件](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/%E4%B8%80%E5%88%87%E7%9A%86%E6%98%AF%E6%96%87%E4%BB%B6.jpg)

虚拟文件系统 VFS 是 Linux 内核中的一个软件层，将不同的实际文件系统抽象，`给用户空间的程序提供统一的文件系统接口`，Linux 的所有实际文件系统都依赖 VFS 共存和协同工作

VFS 为了能够支持各类实际文件系统，定义了所有实际文件系统都支持的概念上的接口和数据结构，同时实际文件系统也提供了 VFS 所期望的抽象接口和数据结构，将自身的诸如文件、目录等概念在形式上与 VFS 的定义保持一致，这样才能与 VFS 协同工作，实际文件系统在统一的接口和数据结构下隐藏了具体的实现细节，因此在 VFS 层和内核的其他部分看来，所有文件系统都是相同的

![VFS](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/VFS.png)

### (2) Linux 虚拟文件系统的目录结构

Linux 虚拟文件系统的目录归类如下

* /：根目录
* /bin：所有用户都可以访问的二进制可执行文件
* /dev：设备文件，通常直接和内存映射，而不是磁盘
  * /dev/null：可以销毁任何输出的虚拟设备文件
  * /dev/zero：产生数字 0 的虚拟设备文件
  * /dev/ramdom：产生随机数的虚拟设备文件
* /etc：配置文件
* /proc：进程和内核文件，存储执行中进程和内核的信息
* /sbin：系统二进制可执行文件
* /tmp：临时文件
* /var：运行时的可变数据文件
* /boot：启动文件
* /opt：第三方可选软件
* /root：root 用户家目录
* /home：用户家目录，存放用户的个人数据
* /media：自动挂载的多媒体设备文件
* /mnt：手动挂载的多媒体设备文件
* /svr：服务数据文件
* /usr：系统资源文件

![Linux 虚拟文件系统的目录结构](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA/Linux%20%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png)

### (3) Linux 虚拟文件系统的文件调用

Linux VFS 给用户空间的程序提供统一的文件系统接口

| 文件调用  | 作用                         |
| --------- | ---------------------------- |
| fcntl     | 文件控制                     |
| open      | 打开文件                     |
| creat     | 创建新文件                   |
| close     | 关闭文件描述字               |
| read      | 读文件                       |
| write     | 写文件                       |
| readv     | 从文件读入数据到缓冲数组中   |
| writev    | 将缓冲数组里的数据写入文件   |
| prea      | 对文件随机读                 |
| pwrite    | 对文件随机写                 |
| lseek     | 移动文件指针                 |
| _llseek   | 在64位地址空间里移动文件指针 |
| dup       | 复制已打开的文件描述字       |
| dup2      | 按指定条件复制文件描述字     |
| flock     | 文件加/解锁                  |
| poll      | I/O多路转换                  |
| truncate  | 截断文件                     |
| ftruncate | 参见truncate                 |
| umask     | 设置文件权限掩码             |
| fsync     | 把文件在内存中的部分写回磁盘 |
