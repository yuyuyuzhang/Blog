# 四、IP 协议

[[_TOC_]]

## 1. 网络层

### (1) 网络层作用

* 有了`以太网协议、MAC 地址、广播的传输方式`，基本上世界上所有的计算机都可以相互通信了，但是如果所有的通信都采用以太网协议的广播方式，那么一台计算机发送的数据帧全世界的计算机都会收到，这将是一种灾难
* 世界范围的互联网是由一个个局域网组成，网络层规定一个局域网是一个`广播域/子网`，以太网的广播传输方式只能在一个子网内发送，跨子网通信必须通过`路由器`转发，`所有主机和路由器`都维护一张`路由控制表`，从路由控制表中找到与 IP 报文首部的目标主机 IP 地址`相同网络号`的记录，该记录就是下一跳主机或路由器的 IP 地址，而如何由 IP 地址在网络中找到具体的设备，这就需要 `ARP 协议`通过 IP 地址解析得到 MAC 地址，在数据链路层封装成以太网数据帧传输
* 在浏览器访问网页时，用户通常输入`应用层地址（主机名、域名）`，但是主机在网络层是根据 IP 地址通信，所以需要一种将应用层地址（主机名、域名）映射为 IP 地址的功能，这就是 `DNS`
* 网络层主要负责不同子网间的`路由寻址`

### (2) 路由器

① 路由器主要用于连接两个组建好的子网，并在不同的子网间转发 IP 报文，并通过宽带上网功能接入互联网

② 路由器同样具有交换机的连接不同计算机组建局域网的功能，但是路由器价格昂贵，并且速度没有交换机快

③ 路由器一般有 5 个端口，1 个为 WAN 端口与宽带线相连，实现宽带上网功能，其他 4 个端口相当于交换机的交换端口，可以与计算机相连，所以 1 个路由器最多可支持 4 台计算机上网，但是这 4 个端口可以与交换机相连，将每个交换机组建好的局域网连接起来，那么就可以支持更多的计算机上网

### (3) IP 协议

IP（Internet Protocol）协议工作在网络层，IP 协议就是规定网络地址的协议，IP 协议定义的网络地址也称为 IP 地址

#### ① 面向无连接

IP 协议采用面向无连接的传输方式，在发送 IP 报文之前，无需建立与目标主机间的连接，上层如果遇到需要发送的数据，该数据会被立刻压缩成 IP 报文发送出去，无论目标主机是否存在

* **由来**：一是为了简化，二是为了提速，面向无连接比面向有连接的传输方式处理更加简单，而且无需事先建立连接，自然实现了高速
* **不可靠**：IP 协议做不到最终收到与否的验证，IP 报文在发送途中可能出现丢包、错位、数量翻倍等问题，因此提高通信的可靠性很重要，`网络层的 IP 协议只负责将数据发送给目标主机，传输层的 TCP 协议负责保证目标主机确实收到数据`
* **原因**：为什么不让 IP 协议具有可靠传输的功能，因为如果要一种协议规定所有的功能与作用，那么该协议的具体实施和编程就会变得十分复杂，无法轻易实现

## 2. IP 地址

### (1) 作用

① IP 地址用于在连接到网络的所有主机中识别出通信的目标主机，因此在 TCP/IP 通信中所有主机和路由器都必须设定自己的 IP 地址

* **主机**：配有 IP 地址但不进行路由控制的设备
* **路由器**：配有 IP 地址且具有路由控制的设备

② 实际上 IP 地址并非根据主机或者路由器来配置的，而是根据网卡配置的，一块网卡可以配置多个 IP 地址，因此一台主机可以有多个 IP 地址，而一台路由器通常有多个网卡，那么就有多个 IP 地址

### (2) 组成

IP 地址 = 网络号 + 主机号

#### ① 网络号

网络号用于标识主机所在的子网，必须保证相互连接的多个子网的网络号互不重复

#### ② 主机号

主机号用于标识处于同一子网内的主机，必须保证同一子网内的各个主机的主机号互不重复

#### ③ IP 地址具有唯一性

通过网络号和主机号，在各个子网相互连接的整个网络中，保证了 IP 地址的唯一性

#### ④ IP 地址具有层次性

具有相同网络号的主机基本都处于地理位置上的同一片区域，如一个部门，一个公司等，因此 IP 地址具有层次性

## 3. IPv4 地址

### (1) IPv4 地址

① IPv4 地址长度为 4 个 8 位字节，即 32 比特

② IPv4 地址以 8 个比特为一组，每组以 `.` 隔开，再转成十进制表示

![IPv4地址](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%26IP%20%E5%8D%8F%E8%AE%AE%E7%BE%A4/IPv4%E5%9C%B0%E5%9D%80.png)

### (2) 子网掩码

① IPv4 地址的网络号和主机号通过子网掩码区分，子网掩码对应网络号的位全部为 1，对应主机号的位全部为 0

② 子网掩码有 2 种表示方式，一是 IPv4 地址和子网掩码分 2 行分别表示，二是 IPv4 地址后跟 / 网络号位数表示

### (3) 私有 IP 与全局 IP

#### ① 私有 IP

私有 IP 用于没有连接互联网的独立网络中的主机，只需要保证这个独立网络内的 IP 地址唯一

#### ② 全局 IP

* 私有 IP 以外的 IP 称为全局 IP，全局 IP 必须在整个互联网范围内保持唯一
* 全局 IP 由互联网名称与数字地址分配机构 ICANN（Internet Corporation for Assigned Names and Numbers）管理，人们向 ISP 申请接入互联网时，同时还会申请全局 IP

### (4) IPv4 报文首部

**① 版本**：IPv4 的版本号为 4

**② 首部长度**：IPv4 报文首部的大小 4 字节

**③ 总长度**：IPv4 报文的总大小 65535 字节（2 的 16 次方，字段长 16 比特）

**④ 标识**：用于 IPv4 报文分片重组，同一个报文的分片标识值相同，不同报文的分片标识值不同

**⑤ 标志**：IPv4 报文分片的相关信息

**⑥ 片偏移**：IPv4 报文每个分片相对原始数据的位置

**⑦ 生存时间**：IPv4 报文传输过程中可以经过多少个路由器，每经过一个路由器值减 1，直到变为 0 则丢弃该报文

**⑧ 协议**：上一层传输层使用的协议

**⑨ 首部校验和**：校验 IPv4 报文的首部，确保 IPv4 报文不被破坏

**⑩ 源地址和目标地址**：发送端 IPv4 地址，接收端 IPv4 地址

![IPv4报文](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%26IP%20%E5%8D%8F%E8%AE%AE%E7%BE%A4/IPv4%E6%8A%A5%E6%96%87.png)

## 4. IPv6 地址

IPv6 是为了从根本上解决 IPv4 即将耗尽的问题而被标准化的网际协议

### (1) IPv6 地址

① IPv6 地址长度为 8 个 16 位字节，即 128 比特

② IPv6 地址以 16 位比特为一组，每组以 `:` 隔开，出现连续的 0 时，可以将这些 0 省略，以 `::` 隔开，一个 IPv6 地址中最多允许 `1` 个 :: 号，再转成十六进制表示

③ IPv6 地址不存在子网掩码，IPv6 地址前 64 位比特为网络号，后 64 位比特为主机号

![IPv6地址](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%26IP%20%E5%8D%8F%E8%AE%AE%E7%BE%A4/IPv6%E5%9C%B0%E5%9D%80.png)

### (2) IPv6 地址的特点

① IP 地址的扩大与路由控制表的聚合

② 性能提升：IPv4 报文首部长度采用固定值 (40 字节)，IPv6 不再采用首部验证码，IPv6 实现路径 MTU 发现，从这两方面减轻路由器负荷

③ 支持即插即用：IPv6 没有 DHCP 服务器也可以实现自动分配地址

④ 认证与加密：应对伪造 IPv6 地址的网络安全功能，防止线路窃听的功能

⑤ 扩展功能多播、Mobile IP

### (3) IPv6 报文首部

**① 版本**：IPv6 的版本号为 6

**② 流标号**：用于服务质量控制

**③ 有效载荷部分**：IPv6 报文的数据部分的总字节数，不包括报文首部

**④ 下一个首部**：上一层传输层使用的协议

**⑤ 跳数限制**：IPv6 报文传输过程中可以经过多少个路由器，每经过一个路由器值减 1，直到变为 0 则丢弃该报文

**⑥ 源地址和目标地址**：发送端 IPv6 地址，接收端 IPv6 地址

**⑦ 扩展首部**：IPv6 报文首部长度固定，无法添加可选项，而是通过扩展首部进行有效扩展，IPv6 的扩展首部可以是任意个数任意长度

![IPv6报文](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%26IP%20%E5%8D%8F%E8%AE%AE%E7%BE%A4/IPv6%E6%8A%A5%E6%96%87.png)

## 5. 路由控制

### (1) 路由控制表

#### ① 由来

仅有 IP 地址还不足以将 IP 报文发送到目标主机，IP 报文发送过程中还需要类似指明路由器或主机的功能，以便真正发往目标主机，保存这种信息的就是路由控制表，`所有主机和路由器`都维护着一张路由控制表，该表记录着 IP 报文下一步应该发送给哪个路由器或者主机

#### ② 生成

* **静态路由控制**：管理员手动设置路由控制表
* **动态路由控制**：路由器之间交换信息时自动刷新生成路由控制表

#### ③ 制定

IP 协议本身没有制定路由控制表的机制，路由控制表是由`路由协议`制定的

#### ④ 聚合

路由控制表越大，管理所需要的内存和 CPU 就越多，查找路由控制表的时间也会越长，导致转发 IP 报文的性能下降，因此想要构建大规模高性能的网络，需要尽可能削减路由控制表的大小，路由信息的聚合可以有效地削减路由控制表的大小

### (2) 路由控制

① IP 地址的网络号用于路由控制，路由控制表中记录着`网络号`与下一步应该发送的 IP 地址

② 发送 IP 报文时，首先确定 IP 报文首部的目标主机 IP 地址，再从路由控制表中找到与目标主机 IP 地址`相同网络号`的记录，根据该记录将 IP 报文转发给下一个路由器，如果路由控制表中存在多条具有相同网络号的记录，就选择相同位数最多的网络号对应的记录

![路由控制](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%26IP%20%E5%8D%8F%E8%AE%AE%E7%BE%A4/%E8%B7%AF%E7%94%B1%E6%8E%A7%E5%88%B6.png)

## 6. IP 报文的分片与重组

### (1) IP 报文的分片

#### ① 由来

数据链路层的 MAC 地址可以抽象成网络层的 IP 地址，因此对于 IP 地址来说，无论数据链路层使用的是以太网协议还是 PPP 协议等，都将被一视同仁，但是不同的数据链路层协议各自的最大传输单位 MTU 不同，为了解决这个问题，IP 报文采用分片与重组机制

![不同数据链路MTU](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%26IP%20%E5%8D%8F%E8%AE%AE%E7%BE%A4/%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AFMTU.png)

#### ② 原理

* 将较大的 IP 报文分割成多个较小的 IP 报文，分片到达目标主机后，先被目标主机重组成完整的 IP 报文再传给上一层
* 以太网协议的默认 MTU 是 1500 字节，因此一个 4300 字节的 IP 报文无法在一个以太网数据帧中发送完成，此时路由器会将 IP 报文划分为 3 个分片转发

![IP报文的分片](https://github.com/yuyuyuzhang/Blog/blob/master/images/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/TCP%26IP%20%E5%8D%8F%E8%AE%AE%E7%BE%A4/IP%E6%8A%A5%E6%96%87%E7%9A%84%E5%88%86%E7%89%87.png)

#### ③ 缺陷

* 一旦某个分片丢失，整个 IP 报文都会作废
* IP 报文的分片机制会加重路由器的负荷，因此只要允许，是不希望路由器进行 IP 报文的分片处理的

### (2) IP 报文的重组

分片之后的 IP 报文只会被目标主机重组，路由器不负责重组，因为下一站经过其他路由器时还会面临被分片的可能，这会给路由器带来更多的负担，也会降低网络传输效率

### (3) 路径 MTU 发现

为了解决 IP 报文分片机制的缺陷，产生了路径 MTU 发现技术，

**路径 MTU**：从发送端主机到接收端主机间无需分片时的最大 MTU 大小，也就是路径中存在的所有数据链路中最小的 MTU

**路径 MTU 发现**：发送端主机按照路径 MTU 的大小将 IP 报文分片后再发送，避免在中途的路由器上进行分片处理
