# 一、Token

[[_TOC_]]

## 1. Token作用

前端使用用户名和密码向服务器请求认证，服务器认证成功，会产生一个 Token 返回给前端，前端将 Token 保存在 `Cookie`，每次请求时带上 Token 证明自己的合法地位

### (1) 避免同源策略

Token 完全由应用管理，可以避免同源策略

### (2) 避免CSRF攻击

将 Token 保存到 Cookie，只是将 Cookie 当做一个存储机制，而非验证机制，因此 Cookie 不会被 Web 框架用于用户验证，可以保证请求是用户自愿发出的，而不是被伪造的，因此可以避免跨站请求伪造 CSRF 攻击

## 2.  Token状态

### (1) 有状态Token

把所有状态信息都附加在 Token 上，服务器就可以不保存 Token，但仍需认证 Token 有效

① 确认当前 Token 是自己签发的，

② 当前 Token 信息未改动，

签发 Token 和验证 Token 都是服务器，所以可以使用`对称加密算法`来保证上述两点，

### (2) 无状态Token

Token 不携带状态信息，服务器需要保存未到期但已注销的 Token，如果一个 Token 未到期就被用户主动注销，那么服务器需要保存这个 Token，以便下次收到这个仍在有效期内的 Token 时判定其无效

**解决**：前端和服务器可以协商，前端一旦注销成功，就丢掉保存的 Token 和 refreshToken，基于这样的约定，服务器就可以保证收到的 Token 一定是未注销的

① Refresh Token 有效期较长，应该在服务器有状态，以增强安全性，确保用户注销时可控

② 应该考虑使用二次认证来增强敏感操作的安全性

## 3. Token有效期

### (1) 永久

如果 Token 在服务器存入数据库，那么 Token 就是一个永久的身份令牌

### (2) 有效期

① 用户登陆密码具有有效期，一般要求定期改变密码，以防止泄露

② SSL 安全证书同样具有有效期，为了解决吊销问题

因此 Token 一般也具有有效期

### (3) 有效期长度

根据系统的安全需要设置，尽可能短

### (4) Token过期

服务器保存 Token 状态，用户每次发送请求，服务器自动刷新 Token 的过期时间，

#### ① 方式一

 一旦 Token 过期，服务器直接删除保存的 Token，前端发送请求时 Token 认证失败，跳转到登陆页，用户重新登陆

**缺陷**：

* 前后端分离、单页 APP 的情况下，每秒可能发起多次请求，每次都刷新 Token 过期时间会产生非常大的代价，

**解决**：

* 服务器通常将 Token 保存在缓存/内存中，而非数据库/文件，减少每次刷新过期时间的消耗

* 服务器可以设置一个几秒的时间，几秒内的多次请求只刷新一次过期时间

#### ② 方式二

一旦 Token 过期，服务器反馈给前端，前端使用服务器提供的 Refresh Token 接口申请一个新的 Token 使用，前端发送请求时使用新的 Token 认证

**优点**：

用户无需重新登陆，服务器只需要在前端请求更新 Refresh Token 时对 Refresh Token 的有效性进行一次检查，避免了频繁读写

**缺陷**：

Refresh Token 也具备有效期，但是这个有效期比较长，

### (5) Refresh Token过期

用户重新登陆

## 4. 未分离认证业务服务器

认证和业务在同一个服务器上

**用户登陆、业务请求、Token 过期**

![Token1](../../图片/前端工程化/Token/用户登录&业务请求&Token过期.png)

## 5. 分离认证业务服务器

认证服务器和业务服务器分离后，Token 无状态让单点登录变得十分容易，

**前提**：业务服务器收到认证服务器的信任，即业务服务器认证 Token 的密钥和认证服务器创建 Token 的密钥相同

**用户登陆、业务请求、Token 过期**

![Token2](../../图片/前端工程化/Token/分离认证-用户登陆&业务请求&Token过期.png)
