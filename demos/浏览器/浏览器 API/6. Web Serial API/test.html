<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="renderer" content="webkit" />
<meta name="referrer" content="no-referrer" />
<title>test</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
</head>
<body>

<canvas id="canvas" width="" height="100px"></canvas>

<div id="dataList"></div>

<button id="btnConnect">connect</button>
<button id="btnEnd">end</button>

<script>
const ctx = document.querySelector('#canvas').getContext('2d')
const chart = new Chart(ctx, {
    type: 'line',
    options: {
        title: {
            display: true,
            text: new Date().toLocaleDateString()
        }
    },
    data: {
        labels: [],
        datasets: [
            {
                label: 'ugpm3',
                borderColor: 'rgb(255, 99, 132)',
                fill: false,
                data: []
            }, {
                label: 'heat',
                borderColor: 'blue',
                fill: false,
                data: []
            }, {
                label: 'humidity',
                borderColor: 'green',
                fill: false,
                data: []
            }
        ]
    }
})

const dataList = document.querySelector('#dataList')
const butConnect = document.querySelector('#btnConnect')
const butEnd = document.querySelector('#btnEnd')

let keepReading = true;
let reader;
let writer;
let receivedframe = [];

function dealWithData(value) {
    function checkSum(buf) {
        let checksum = 0;
        buf.forEach((val, idx) => {
            if (idx > 0 && idx < 12) {
                checksum += val;
            } else if (idx == 12) {
                checksum = (~checksum & 0xff) + 1;
            }
        });
        return buf[12] == checksum;
    }

    if (checkSum(value)) {
        let ugpm3 = (value[2] << 8) | value[3];
        let heat = ((value[8] << 8) | value[9]) / 100;
        let humidity = ((value[10] << 8) | value[11]) / 100;
        let datatime = new Date();
        let frame = {
            datatime,
            ugpm3,
            heat,
            humidity,
        };

        receivedframe.push(frame);

        dataList.innerHTML += `<p>[${datatime.toLocaleString()}] -> ugpm3: ${ugpm3}, heat: ${heat}, humidity: ${humidity}</p>`;

        chart.data.labels.push(datatime.toLocaleTimeString());
        chart.data.datasets.forEach((dataset) => {
            dataset.data.push(frame[dataset.label]);
        });
        chart.update();
    }
}

butConnect.addEventListener("click", async () => {
    const port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 }); // set baud rate
    keepReading = true;
    reader = port.readable.getReader();
    writer = port.writable.getWriter();

    const writeInt = setInterval(async () => {
        const commandframe = new Uint8Array([
            0x00,
            0xff
        ]);
        await writer.write(commandframe);
    }, 3000);

    while (port.readable && keepReading) {
        try {
            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    reader.releaseLock();
                    writer.releaseLock();
                    break;
                }
                if (value) {
                    dealWithData(value);
                }
            }
        } catch (error) {
            console.error(error);
        } finally {
            console.log(port.readable, keepReading);
        }
    }
    clearInterval(writeInt);
    await port.close();
    console.log("port closed");
});

butEnd.addEventListener("click", async () => {
    keepReading = false;
    reader.cancel();
    const jsonHandle = await window.showSaveFilePicker();
    const writableStream = await jsonHandle.createWritable();
    const aBlob = new Blob([JSON.stringify(receivedframe)], {
        type: "text/plain",
    });
    await writableStream.write(aBlob);
    receivedframe = [];
    await writableStream.close();
});
</script>
</body>
</html>